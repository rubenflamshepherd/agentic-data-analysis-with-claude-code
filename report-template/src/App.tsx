import { useEffect } from 'react';
import {
  Title,
  Text,
  Flex,
  TabGroup,
  TabList,
  Tab,
  TabPanels,
  TabPanel,
  Callout,
} from '@tremor/react';
import { reportData } from './data/report-data';
import { ExecutiveSummary } from './components/ExecutiveSummary';
import { KPIDashboard } from './components/KPIDashboard';
import { ResearchQuestions } from './components/ResearchQuestions';
import { TableTab } from './components/TableTab';
import { Recommendations } from './components/Recommendations';
import { useUrlTabState } from './hooks/useUrlTabState';

function App() {
  const { metadata, tables, advancedAnalyses } = reportData;

  // Set document title from report metadata
  useEffect(() => {
    document.title = metadata.title;
  }, [metadata.title]);
  const hasAdvancedAnalyses = advancedAnalyses && advancedAnalyses.length > 0;

  const {
    primaryTabIndex,
    initialTableIndex,
    advancedTableIndex,
    setPrimaryTab,
    setInitialTable,
    setAdvancedTable,
  } = useUrlTabState(tables, advancedAnalyses || []);

  return (
    <main className="p-6 sm:p-10 max-w-7xl mx-auto">
      {/* Header */}
      <header className="mb-10">
        <Title className="text-3xl font-bold text-gray-900">
          {metadata.title}
        </Title>
        <Text className="mt-2 text-lg text-gray-600">
          {metadata.subtitle}
        </Text>
        <Callout title="How this was built" color="green" className="mt-4">
          This React application was entirely generated by Claude Code from a single skill call.
          Everything you see (other than this alert) was created with no human intervention. The source code/prompts are available <a href="https://github.com/rubenflamshepherd/agentic-data-analysis-with-claude-code" target="_blank" rel="noopener noreferrer" className="underline text-blue-600 hover:text-blue-800">here</a>.
        </Callout>
        <Flex className="mt-4 gap-4" justifyContent="start">
          <Text className="text-sm text-gray-500">
            Generated: {new Date(metadata.generatedAt).toLocaleDateString()}
          </Text>
          <Text className="text-sm text-gray-500">
            Dataset: {metadata.dataset}
          </Text>
          <Text className="text-sm text-gray-500">
            {metadata.dateRange}
          </Text>
        </Flex>
      </header>

      {/* Navigation Tabs */}
      <TabGroup index={primaryTabIndex} onIndexChange={setPrimaryTab}>
        <TabList className="mb-8">
          <Tab>Overview</Tab>
          <Tab>Research Questions</Tab>
          <Tab>Initial Analysis</Tab>
          {hasAdvancedAnalyses ? <Tab>Advanced Analysis</Tab> : <></>}
          <Tab>Next Steps</Tab>
        </TabList>

        <TabPanels>
          <TabPanel>
            <div className="space-y-8">
              <KPIDashboard kpis={reportData.kpis} />
              <ExecutiveSummary findings={reportData.executiveSummary} />
            </div>
          </TabPanel>
          <TabPanel>
            <ResearchQuestions questions={reportData.researchQuestions} />
          </TabPanel>
          <TabPanel>
            {/* Nested tabs for each table */}
            <TabGroup index={initialTableIndex} onIndexChange={setInitialTable}>
              <TabList className="mb-6 flex-wrap">
                {tables.map((table) => (
                  <Tab key={table.tableName} className="font-mono text-sm">
                    {table.tableName}
                  </Tab>
                ))}
              </TabList>
              <TabPanels>
                {tables.map((table) => (
                  <TabPanel key={table.tableName}>
                    <TableTab table={table} />
                  </TabPanel>
                ))}
              </TabPanels>
            </TabGroup>
          </TabPanel>
          {hasAdvancedAnalyses ? (
            <TabPanel>
              {/* Nested tabs for each advanced analysis */}
              <TabGroup index={advancedTableIndex} onIndexChange={setAdvancedTable}>
                <TabList className="mb-6 flex-wrap">
                  {advancedAnalyses!.map((analysis) => (
                    <Tab key={analysis.tableName} className="font-mono text-sm">
                      {analysis.tableName}
                    </Tab>
                  ))}
                </TabList>
                <TabPanels>
                  {advancedAnalyses!.map((analysis) => (
                    <TabPanel key={analysis.tableName}>
                      <TableTab table={analysis} />
                    </TabPanel>
                  ))}
                </TabPanels>
              </TabGroup>
            </TabPanel>
          ) : <></>}
          <TabPanel>
            <Recommendations recommendations={reportData.recommendations} />
          </TabPanel>
        </TabPanels>
      </TabGroup>

      {/* Footer */}
      <footer className="mt-16 pt-8 border-t border-gray-200 text-center text-gray-500 text-sm">
        <p>Generated by Claude Code Data Analysis Pipeline</p>
        <p className="mt-1">Files: ./research/</p>
      </footer>
    </main>
  );
}

export default App;
